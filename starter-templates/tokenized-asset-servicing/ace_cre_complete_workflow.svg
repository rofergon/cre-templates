<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1600 1100" width="100%" height="100%" style="background-color:#f8fafc;font-family:'Segoe UI','Inter',-apple-system,sans-serif;">
  <defs>
    <filter id="shadow-sm" x="-10%" y="-10%" width="120%" height="120%">
      <feDropShadow dx="0" dy="2" stdDeviation="4" flood-color="#000000" flood-opacity="0.08"/>
    </filter>
    <filter id="shadow-md" x="-10%" y="-10%" width="120%" height="120%">
      <feDropShadow dx="0" dy="6" stdDeviation="10" flood-color="#000000" flood-opacity="0.12"/>
    </filter>

    <linearGradient id="head-grad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#1d4ed8"/>
      <stop offset="100%" stop-color="#1e3a8a"/>
    </linearGradient>

    <linearGradient id="setup-grad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" stop-color="#e0f2fe"/>
      <stop offset="100%" stop-color="#dbeafe"/>
    </linearGradient>

    <linearGradient id="runtime-grad" x1="0%" y1="0%" x2="100%" y2="0%">
      <stop offset="0%" stop-color="#ecfeff"/>
      <stop offset="100%" stop-color="#eef2ff"/>
    </linearGradient>

    <marker id="arrowDark" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="7" markerHeight="7" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#334155"/>
    </marker>
    <marker id="arrowBlue" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="7" markerHeight="7" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#1d4ed8"/>
    </marker>
    <marker id="arrowGreen" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="7" markerHeight="7" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#15803d"/>
    </marker>
  </defs>

  <text x="800" y="50" font-size="32" font-weight="700" fill="#0f172a" text-anchor="middle">Flujo Completo CRE + ACE (Integracion realizada)</text>
  <text x="800" y="80" font-size="14" fill="#475569" text-anchor="middle">KYC onchain, privacidad ACE, ticket de retiro y redeem en Sepolia desde wallet del empleado</text>

  <rect x="40" y="110" width="1520" height="960" rx="20" fill="#ffffff" stroke="#cbd5e1" stroke-width="2" filter="url(#shadow-md)"/>

  <rect x="70" y="140" width="1460" height="240" rx="14" fill="url(#setup-grad)" stroke="#93c5fd" stroke-width="2"/>
  <rect x="70" y="410" width="1460" height="630" rx="14" fill="url(#runtime-grad)" stroke="#a5b4fc" stroke-width="2"/>

  <rect x="70" y="140" width="1460" height="44" rx="14" fill="url(#head-grad)"/>
  <text x="130" y="169" font-size="18" font-weight="700" fill="#ffffff">Fase 1: Setup de compliance ACE (una vez)</text>

  <rect x="100" y="210" width="400" height="135" rx="10" fill="#ffffff" stroke="#7dd3fc" stroke-width="2" filter="url(#shadow-sm)"/>
  <text x="300" y="242" font-size="15" font-weight="700" fill="#0c4a6e" text-anchor="middle">1) Deploy Policy Engine</text>
  <text x="300" y="265" font-size="12" fill="#0369a1" text-anchor="middle">Foundry script: `01_DeployPolicyEngine.s.sol`</text>
  <text x="300" y="286" font-size="12" fill="#0369a1" text-anchor="middle">Usar direccion PROXY como policy engine</text>
  <text x="300" y="307" font-size="12" fill="#0369a1" text-anchor="middle">Correcto: `0xc75E...`</text>
  <text x="300" y="327" font-size="12" fill="#b91c1c" text-anchor="middle">No usar implementacion: `0x36Ac...`</text>

  <rect x="560" y="210" width="400" height="135" rx="10" fill="#ffffff" stroke="#7dd3fc" stroke-width="2" filter="url(#shadow-sm)"/>
  <text x="760" y="242" font-size="15" font-weight="700" fill="#0c4a6e" text-anchor="middle">2) Registrar o actualizar en vault</text>
  <text x="760" y="265" font-size="12" fill="#0369a1" text-anchor="middle">`npm --prefix contracts run ace:setup-policy`</text>
  <text x="760" y="286" font-size="12" fill="#0369a1" text-anchor="middle">script: `contracts/scripts/setup_ace_policy.cjs`</text>
  <text x="760" y="307" font-size="12" fill="#0369a1" text-anchor="middle">Llama `register(token, policyEngine)`</text>

  <rect x="1020" y="210" width="480" height="135" rx="10" fill="#ffffff" stroke="#7dd3fc" stroke-width="2" filter="url(#shadow-sm)"/>
  <text x="1260" y="242" font-size="15" font-weight="700" fill="#0c4a6e" text-anchor="middle">3) Verificacion final</text>
  <text x="1260" y="265" font-size="12" fill="#0369a1" text-anchor="middle">`checkDepositAllowed` = OK</text>
  <text x="1260" y="286" font-size="12" fill="#0369a1" text-anchor="middle">`checkWithdrawAllowed` = OK</text>
  <text x="1260" y="307" font-size="12" fill="#0369a1" text-anchor="middle">`checkPrivateTransferAllowed` = OK</text>
  <text x="1260" y="327" font-size="12" fill="#15803d" text-anchor="middle">Token registrado con engine proxy correcto</text>

  <path d="M 500 278 L 560 278" stroke="#334155" stroke-width="3" fill="none" marker-end="url(#arrowDark)"/>
  <path d="M 960 278 L 1020 278" stroke="#334155" stroke-width="3" fill="none" marker-end="url(#arrowDark)"/>

  <rect x="70" y="410" width="1460" height="44" rx="14" fill="url(#head-grad)"/>
  <text x="130" y="439" font-size="18" font-weight="700" fill="#ffffff">Fase 2: Operacion end-to-end (CRE + ACE + empleado)</text>

  <rect x="100" y="500" width="290" height="115" rx="10" fill="#ffffff" stroke="#86efac" stroke-width="2" filter="url(#shadow-sm)"/>
  <text x="245" y="532" font-size="14" font-weight="700" fill="#166534" text-anchor="middle">A) Trigger externo</text>
  <text x="245" y="555" font-size="12" fill="#15803d" text-anchor="middle">Lambda / HR API envia JSON</text>
  <text x="245" y="575" font-size="12" fill="#15803d" text-anchor="middle">ej: `SYNC_KYC` o accion `ACE_*`</text>

  <rect x="430" y="480" width="360" height="175" rx="10" fill="#ffffff" stroke="#93c5fd" stroke-width="2" filter="url(#shadow-sm)"/>
  <text x="610" y="512" font-size="14" font-weight="700" fill="#1e3a8a" text-anchor="middle">B) `EquityWorkflowCre/main.ts`</text>
  <text x="610" y="535" font-size="12" fill="#1d4ed8" text-anchor="middle">Parsea input y enruta por tipo de accion</text>
  <text x="610" y="557" font-size="12" fill="#1d4ed8" text-anchor="middle">`SYNC_*` -> report onchain con CRE</text>
  <text x="610" y="578" font-size="12" fill="#1d4ed8" text-anchor="middle">`ACE_*` -> API ACE con firma EIP-712</text>
  <text x="610" y="599" font-size="12" fill="#1d4ed8" text-anchor="middle">Domain: CompliantPrivateTokenDemo</text>
  <text x="610" y="620" font-size="12" fill="#1d4ed8" text-anchor="middle">Secrets: `ACE_API_SIGNER_PRIVATE_KEY`</text>
  <text x="610" y="641" font-size="11" fill="#b91c1c" text-anchor="middle">`SYNC_REDEEM_TICKET` deshabilitado en receiver</text>

  <rect x="830" y="500" width="300" height="115" rx="10" fill="#ffffff" stroke="#93c5fd" stroke-width="2" filter="url(#shadow-sm)"/>
  <text x="980" y="532" font-size="14" font-weight="700" fill="#1e3a8a" text-anchor="middle">C) Ruta SYNC_* onchain</text>
  <text x="980" y="555" font-size="12" fill="#1d4ed8" text-anchor="middle">CRE `writeReport()`</text>
  <text x="980" y="575" font-size="12" fill="#1d4ed8" text-anchor="middle">`EquityWorkflowReceiver.sol` ejecuta</text>
  <text x="980" y="595" font-size="12" fill="#1d4ed8" text-anchor="middle">KYC / freeze / private deposit</text>

  <rect x="1170" y="500" width="330" height="115" rx="10" fill="#ffffff" stroke="#60a5fa" stroke-width="2" filter="url(#shadow-sm)"/>
  <text x="1335" y="532" font-size="14" font-weight="700" fill="#1e40af" text-anchor="middle">D) Contratos equity</text>
  <text x="1335" y="555" font-size="12" fill="#2563eb" text-anchor="middle">Compliance / IdentityRegistry</text>
  <text x="1335" y="575" font-size="12" fill="#2563eb" text-anchor="middle">EmployeeVesting / token logic</text>

  <rect x="100" y="700" width="690" height="175" rx="10" fill="#ffffff" stroke="#34d399" stroke-width="2" filter="url(#shadow-sm)"/>
  <text x="445" y="732" font-size="14" font-weight="700" fill="#065f46" text-anchor="middle">F) Accion del empleado (wallet separada)</text>
  <text x="445" y="755" font-size="12" fill="#047857" text-anchor="middle">Script: `ace-private-transfers/api-scripts/src/withdraw-and-redeem.ts`</text>
  <text x="445" y="776" font-size="12" fill="#047857" text-anchor="middle">1) Firma EIP-712 y pide ticket `/withdraw`</text>
  <text x="445" y="797" font-size="12" fill="#047857" text-anchor="middle">2) Llama `vault.withdrawWithTicket(token, amount, ticket)`</text>
  <text x="445" y="818" font-size="12" fill="#047857" text-anchor="middle">3) Opcional: `transfer(recipient)` a direccion real final</text>
  <text x="445" y="839" font-size="12" fill="#047857" text-anchor="middle">Redeem fuera de la ruta CRE directa</text>

  <rect x="830" y="700" width="670" height="175" rx="10" fill="#ffffff" stroke="#818cf8" stroke-width="2" filter="url(#shadow-sm)"/>
  <text x="1165" y="732" font-size="14" font-weight="700" fill="#3730a3" text-anchor="middle">E) Ruta ACE privada (antes del claim)</text>
  <text x="1165" y="755" font-size="12" fill="#4338ca" text-anchor="middle">`ACE_GENERATE_SHIELDED_ADDRESS` -> `/shielded-address`</text>
  <text x="1165" y="776" font-size="12" fill="#4338ca" text-anchor="middle">`ACE_PRIVATE_TRANSFER` -> `/private-transfer`</text>
  <text x="1165" y="797" font-size="12" fill="#4338ca" text-anchor="middle">Valida con `checkPrivateTransferAllowed` en vault</text>
  <text x="1165" y="818" font-size="12" fill="#4338ca" text-anchor="middle">`ACE_WITHDRAW_TICKET` -> `/withdraw` (ticket + deadline 1h)</text>
  <text x="1165" y="839" font-size="12" fill="#4338ca" text-anchor="middle">Vault demo Sepolia: `0xE588a6...`</text>

  <rect x="470" y="900" width="660" height="95" rx="10" fill="#fefce8" stroke="#facc15" stroke-width="2" filter="url(#shadow-sm)"/>
  <text x="800" y="932" font-size="15" font-weight="700" fill="#854d0e" text-anchor="middle">Resultado final del flujo implementado</text>
  <text x="800" y="956" font-size="12" fill="#a16207" text-anchor="middle">Compliance centralizado en ACE policy engine + privacidad previa al retiro</text>
  <text x="800" y="977" font-size="12" fill="#a16207" text-anchor="middle">El redeem ocurre onchain desde la wallet del empleado</text>

  <path d="M 390 557 L 430 557" stroke="#1d4ed8" stroke-width="3" fill="none" marker-end="url(#arrowBlue)"/>
  <path d="M 790 557 L 830 557" stroke="#1d4ed8" stroke-width="3" fill="none" marker-end="url(#arrowBlue)"/>
  <path d="M 1130 557 L 1170 557" stroke="#1d4ed8" stroke-width="3" fill="none" marker-end="url(#arrowBlue)"/>

  <path d="M 760 640 L 830 700" stroke="#4338ca" stroke-width="2.5" fill="none" marker-end="url(#arrowBlue)"/>

  <path d="M 445 875 L 445 900 L 560 900" stroke="#15803d" stroke-width="3" fill="none" marker-end="url(#arrowGreen)"/>
  <path d="M 1165 875 L 1165 920 L 1130 920" stroke="#1d4ed8" stroke-width="3" fill="none" marker-end="url(#arrowBlue)"/>

  <rect x="100" y="1005" width="360" height="30" rx="15" fill="#d1fae5" stroke="#34d399" stroke-width="1"/>
  <text x="280" y="1025" font-size="11" fill="#065f46" text-anchor="middle">Fechas clave: integracion completada en Feb 2026</text>

  <rect x="1140" y="1005" width="360" height="30" rx="15" fill="#dbeafe" stroke="#60a5fa" stroke-width="1"/>
  <text x="1320" y="1025" font-size="11" fill="#1e40af" text-anchor="middle">Red: Ethereum Sepolia (chainId 11155111)</text>
</svg>
