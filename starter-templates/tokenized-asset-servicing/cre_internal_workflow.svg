<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 700" width="100%" height="100%" style="background-color: #f8fafc; font-family: 'Segoe UI', 'Inter', -apple-system, sans-serif;">
  <defs>
    <filter id="shadow-sm" x="-10%" y="-10%" width="120%" height="120%">
      <feDropShadow dx="0" dy="2" stdDeviation="4" flood-color="#000000" flood-opacity="0.06"/>
    </filter>
    <filter id="shadow-md" x="-10%" y="-10%" width="120%" height="120%">
      <feDropShadow dx="0" dy="6" stdDeviation="8" flood-color="#000000" flood-opacity="0.10"/>
    </filter>
    
    <linearGradient id="cre-grad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#2a5ada"/>
      <stop offset="100%" stop-color="#193db0"/>
    </linearGradient>

    <!-- Arrow Markers -->
    <marker id="arrowSolid" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#334155"/>
    </marker>
    <marker id="arrowBlue" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#2a5ada"/>
    </marker>
  </defs>

  <!-- Title Section -->
  <text x="500" y="50" font-size="28" font-weight="bold" fill="#1e293b" text-anchor="middle">Chainlink CRE: Internal Workflow Logic</text>
  <text x="500" y="80" font-size="14" fill="#64748b" text-anchor="middle">Execution flow for main.ts â€” 5 ActionTypes (v2: incl. SYNC_CREATE_GRANT)</text>

  <!-- Main CRE Container -->
  <rect x="80" y="120" width="840" height="520" rx="16" fill="#ffffff" stroke="#2a5ada" stroke-width="3" filter="url(#shadow-md)"/>
  
  <!-- CRE Header Strip -->
  <rect x="80" y="120" width="840" height="60" rx="16" fill="url(#cre-grad)"/>
  <path d="M 80 160 L 920 160 L 920 180 L 80 180 Z" fill="url(#cre-grad)"/>
  <text x="500" y="158" font-size="22" font-weight="bold" fill="#ffffff" text-anchor="middle">Chainlink Runtime Environment</text>

  <!-- =============================== INPUTS =============================== -->
  
  <text x="210" y="215" font-size="16" font-weight="bold" fill="#64748b" text-anchor="middle">INPUT TRIGGERS</text>

  <!-- HTTP POST Trigger (Top Left) -->
  <rect x="120" y="240" width="180" height="80" rx="8" fill="#f0fdf4" stroke="#86efac" stroke-width="2"/>
  <text x="210" y="270" font-size="14" font-weight="bold" fill="#166534" text-anchor="middle">HTTP Trigger</text>
  <text x="210" y="290" font-size="12" fill="#166534" text-anchor="middle">Receives `POST JSON`</text>
  <text x="210" y="305" font-size="10" fill="#22c55e" text-anchor="middle">(Web2 HR / AWS Lambda)</text>

  <!-- EVM Log Trigger (Bottom Left) -->
  <rect x="120" y="440" width="180" height="80" rx="8" fill="#f0fdf4" stroke="#86efac" stroke-width="2"/>
  <text x="210" y="470" font-size="14" font-weight="bold" fill="#166534" text-anchor="middle">EVM Log Trigger</text>
  <text x="210" y="490" font-size="12" fill="#166534" text-anchor="middle">Listens for `Smart Contract`</text>
  <text x="210" y="505" font-size="10" fill="#22c55e" text-anchor="middle">Events (Identity &amp; Vesting)</text>

  <line x1="120" y1="380" x2="300" y2="380" stroke="#e2e8f0" stroke-width="2" stroke-dasharray="6"/>


  <!-- ========================== PROCESSING LOGIC ========================== -->

  <text x="500" y="215" font-size="16" font-weight="bold" fill="#64748b" text-anchor="middle">WORKFLOW EXECUTION</text>
  <rect x="360" y="240" width="280" height="340" rx="8" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="2" stroke-dasharray="4"/>
  <rect x="440" y="228" width="120" height="24" rx="4" fill="#e2e8f0" stroke="#cbd5e1" stroke-width="1"/>
  <text x="500" y="245" font-size="12" font-weight="bold" fill="#475569" text-anchor="middle">Typescript (main.ts)</text>

  <!-- Parse & Validate -->
  <rect x="390" y="270" width="220" height="40" rx="6" fill="#ffffff" stroke="#94a3b8" stroke-width="1" filter="url(#shadow-sm)"/>
  <text x="500" y="295" font-size="14" font-weight="bold" fill="#334155" text-anchor="middle">Zod Parsing &amp; Validation</text>

  <!-- Instruction Builder -->
  <rect x="390" y="350" width="220" height="60" rx="6" fill="#ffffff" stroke="#94a3b8" stroke-width="1" filter="url(#shadow-sm)"/>
  <text x="500" y="370" font-size="14" font-weight="bold" fill="#334155" text-anchor="middle">Build Transaction Instruction</text>
  <text x="500" y="388" font-size="12" fill="#64748b" text-anchor="middle">(Viem: encodeAbiParameters)</text>
  <text x="500" y="402" font-size="9" fill="#8b5cf6" text-anchor="middle">KYC(0) EMP(1) GOAL(2) FREEZE(3) GRANT(4)</text>

  <!-- Decentralized Consensus Module -->
  <rect x="375" y="460" width="250" height="90" rx="8" fill="#eff6ff" stroke="#bfdbfe" stroke-width="2" filter="url(#shadow-sm)"/>
  <text x="500" y="485" font-size="14" font-weight="bold" fill="#1e3a8a" text-anchor="middle">Decentralized Consensus</text>
  <text x="500" y="505" font-size="12" fill="#3b82f6" text-anchor="middle">Identical Aggregation</text>
  <rect x="420" y="515" width="160" height="24" rx="12" fill="#ffffff" stroke="#93c5fd" stroke-width="1"/>
  <text x="500" y="531" font-size="11" font-weight="bold" fill="#2563eb" text-anchor="middle">runtime.report()</text>


  <!-- ============================== OUTPUTS ============================== -->

  <text x="790" y="215" font-size="16" font-weight="bold" fill="#64748b" text-anchor="middle">OUTPUT CAPABILITIES</text>

  <!-- Write Report Action (Top Right) -->
  <rect x="700" y="340" width="180" height="80" rx="8" fill="#eff6ff" stroke="#93c5fd" stroke-width="2"/>
  <text x="790" y="370" font-size="14" font-weight="bold" fill="#1d4ed8" text-anchor="middle">EVM Client Capability</text>
  <text x="790" y="390" font-size="12" fill="#1e3a8a" text-anchor="middle">Executes `writeReport()`</text>
  <text x="790" y="405" font-size="10" fill="#2563eb" text-anchor="middle">(Dest: Receiver.sol)</text>

  <!-- HTTP Call Action (Bottom Right Reverse flow) -->
  <rect x="700" y="500" width="180" height="80" rx="8" fill="#eff6ff" stroke="#93c5fd" stroke-width="2"/>
  <text x="790" y="530" font-size="14" font-weight="bold" fill="#1d4ed8" text-anchor="middle">HTTP Client Capability</text>
  <text x="790" y="550" font-size="12" fill="#1e3a8a" text-anchor="middle">Sends `POST JSON` webhook</text>
  <text x="790" y="565" font-size="10" fill="#2563eb" text-anchor="middle">(Dest: AWS Lambda URL)</text>


  <!-- =============================== PATHS =============================== -->
  
  <!-- HTTP Trigger to Zod Parse -->
  <path d="M 300 280 L 345 280 L 345 290 L 390 290" fill="none" stroke="#64748b" stroke-width="2" marker-end="url(#arrowSolid)"/>
  
  <!-- Zod Parse down to ABI Build -->
  <path d="M 500 310 L 500 350" fill="none" stroke="#64748b" stroke-width="2" marker-end="url(#arrowSolid)"/>

  <!-- ABI Build down to Consensus -->
  <path d="M 500 400 L 500 460" fill="none" stroke="#64748b" stroke-width="2" marker-end="url(#arrowSolid)"/>
  
  <!-- EVM Log up to Instruction parsing logic inside Consensus/Logic block -->
  <path d="M 300 480 L 330 480 L 330 375 L 390 375" fill="none" stroke="#64748b" stroke-width="2" marker-end="url(#arrowSolid)"/>
  <rect x="305" y="415" width="40" height="20" rx="4" fill="#ffffff" stroke="#cbd5e1" stroke-width="1"/>
  <text x="325" y="429" font-size="10" fill="#64748b" text-anchor="middle">Log</text>

  <!-- Consesus out to Write Report -->
  <path d="M 625 480 L 660 480 L 660 380 L 700 380" fill="none" stroke="#2a5ada" stroke-width="3" marker-end="url(#arrowBlue)"/>
  
  <!-- Consensus routing out to HTTP Call -->
  <path d="M 625 540 L 700 540" fill="none" stroke="#2a5ada" stroke-width="3" marker-end="url(#arrowBlue)"/>

</svg>
