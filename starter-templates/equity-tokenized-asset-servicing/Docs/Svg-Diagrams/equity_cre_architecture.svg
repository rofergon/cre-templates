<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1560 980" width="100%" height="100%" style="background:#f3f7fb;font-family:'Segoe UI','Inter',Arial,sans-serif;">
  <defs>
    <filter id="shadow" x="-10%" y="-10%" width="120%" height="120%">
      <feDropShadow dx="0" dy="4" stdDeviation="7" flood-color="#0f172a" flood-opacity="0.12"/>
    </filter>

    <linearGradient id="laneWeb2" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#ffffff"/>
      <stop offset="100%" stop-color="#edf4ff"/>
    </linearGradient>
    <linearGradient id="laneCre" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#204db8"/>
      <stop offset="100%" stop-color="#17398a"/>
    </linearGradient>
    <linearGradient id="laneChain" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#2b3647"/>
      <stop offset="100%" stop-color="#111827"/>
    </linearGradient>
    <linearGradient id="laneAce" x1="0" y1="0" x2="1" y2="1">
      <stop offset="0%" stop-color="#ffffff"/>
      <stop offset="100%" stop-color="#f6eeff"/>
    </linearGradient>

    <marker id="arrBlue" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#2563eb"/>
    </marker>
    <marker id="arrGreen" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#10b981"/>
    </marker>
    <marker id="arrPurple" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#7c3aed"/>
    </marker>
    <marker id="arrOrange" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#ea580c"/>
    </marker>
  </defs>

  <text x="780" y="52" font-size="34" font-weight="700" fill="#0f172a" text-anchor="middle">Equity CRE Architecture (Updated)</text>
  <text x="780" y="82" font-size="15" fill="#475569" text-anchor="middle">Current flow for Lambda -> CRE -> Receiver -> ACE Vault/Ticket, including goal and cliff gating</text>

  <!-- Lanes -->
  <rect x="24" y="120" width="320" height="820" rx="16" fill="url(#laneWeb2)" stroke="#cbd5e1" stroke-width="2" filter="url(#shadow)"/>
  <rect x="364" y="120" width="430" height="820" rx="16" fill="#ffffff" stroke="#1d4ed8" stroke-width="3" filter="url(#shadow)"/>
  <rect x="364" y="120" width="430" height="76" rx="16" fill="url(#laneCre)"/>
  <path d="M 364 180 L 794 180 L 794 196 L 364 196 Z" fill="url(#laneCre)"/>
  <rect x="814" y="120" width="360" height="820" rx="16" fill="url(#laneChain)" filter="url(#shadow)"/>
  <rect x="1194" y="120" width="342" height="820" rx="16" fill="url(#laneAce)" stroke="#d8b4fe" stroke-width="2" filter="url(#shadow)"/>

  <text x="184" y="166" font-size="23" font-weight="700" fill="#334155" text-anchor="middle">Web2 / Ops</text>
  <text x="579" y="170" font-size="23" font-weight="700" fill="#ffffff" text-anchor="middle">Chainlink Runtime Environment</text>
  <text x="579" y="191" font-size="12" fill="#c7d2fe" text-anchor="middle">EquityWorkflowCre/main.ts</text>
  <text x="994" y="166" font-size="23" font-weight="700" fill="#ffffff" text-anchor="middle">Onchain / Sepolia</text>
  <text x="1365" y="166" font-size="23" font-weight="700" fill="#5b21b6" text-anchor="middle">ACE Offchain Rail</text>

  <!-- Web2 blocks -->
  <rect x="44" y="190" width="280" height="90" rx="10" fill="#ffffff" stroke="#dbeafe" stroke-width="2"/>
  <text x="184" y="220" font-size="17" font-weight="700" fill="#1e293b" text-anchor="middle">HR/Admin Input</text>
  <text x="184" y="241" font-size="12" fill="#64748b" text-anchor="middle">KYC, employment, goals, cliff, freeze</text>
  <text x="184" y="258" font-size="11" fill="#64748b" text-anchor="middle">and optional mint/deposit intents</text>

  <rect x="44" y="305" width="280" height="120" rx="10" fill="#ffffff" stroke="#dbeafe" stroke-width="2"/>
  <text x="184" y="335" font-size="17" font-weight="700" fill="#1e293b" text-anchor="middle">AWS Lambda API</text>
  <text x="184" y="356" font-size="12" fill="#64748b" text-anchor="middle">Stores `CompanyEmployeeInput`</text>
  <text x="184" y="374" font-size="12" fill="#64748b" text-anchor="middle">Builds payloads for CRE actions</text>
  <text x="184" y="392" font-size="11" fill="#1d4ed8" font-weight="700" text-anchor="middle">POST JSON trigger to CRE</text>

  <rect x="44" y="450" width="280" height="170" rx="10" fill="#ffffff" stroke="#dbeafe" stroke-width="2"/>
  <text x="184" y="480" font-size="17" font-weight="700" fill="#1e293b" text-anchor="middle">E2E Test Runner</text>
  <text x="184" y="501" font-size="12" fill="#64748b" text-anchor="middle">`npm --prefix EquityWorkflowCre`</text>
  <text x="184" y="519" font-size="12" fill="#64748b" text-anchor="middle">`run test:lambda-cre-ace-ticket`</text>
  <text x="184" y="537" font-size="11" fill="#334155" text-anchor="middle">Can use `USE_DIRECT_RECEIVER_REPORTS=true`</text>
  <text x="184" y="555" font-size="11" fill="#334155" text-anchor="middle">to bypass forwarder in local simulation</text>
  <text x="184" y="576" font-size="11" fill="#0f766e" font-weight="700" text-anchor="middle">Validates full ticket redeem by employee wallet</text>

  <rect x="44" y="645" width="280" height="120" rx="10" fill="#ffffff" stroke="#dbeafe" stroke-width="2"/>
  <text x="184" y="675" font-size="17" font-weight="700" fill="#1e293b" text-anchor="middle">Environment + Config</text>
  <text x="184" y="696" font-size="12" fill="#64748b" text-anchor="middle">`.env` + `config.staging/production`</text>
  <text x="184" y="714" font-size="12" fill="#64748b" text-anchor="middle">Admin/Employee keys, vault, API base</text>
  <text x="184" y="732" font-size="11" fill="#64748b" text-anchor="middle">Receiver/registry/token/privateEq addresses</text>

  <!-- CRE blocks -->
  <rect x="384" y="190" width="390" height="78" rx="10" fill="#ecfeff" stroke="#67e8f9" stroke-width="2"/>
  <text x="579" y="220" font-size="18" font-weight="700" fill="#155e75" text-anchor="middle">HTTP Trigger</text>
  <text x="579" y="242" font-size="12" fill="#0f766e" text-anchor="middle">Validates JSON and routes by `action`</text>

  <rect x="384" y="286" width="390" height="270" rx="10" fill="#eff6ff" stroke="#bfdbfe" stroke-width="2"/>
  <text x="579" y="314" font-size="19" font-weight="700" fill="#1e3a8a" text-anchor="middle">Action Router (`main.ts`)</text>

  <rect x="404" y="332" width="350" height="100" rx="8" fill="#ffffff" stroke="#cbd5e1" stroke-width="1.5"/>
  <text x="579" y="355" font-size="13" font-weight="700" fill="#334155" text-anchor="middle">Onchain Actions (actionType 0..8)</text>
  <text x="579" y="375" font-size="11" fill="#64748b" text-anchor="middle">0 KYC, 1 EMPLOYMENT, 2 GOAL, 3 FREEZE, 4 PRIVATE_DEPOSIT</text>
  <text x="579" y="392" font-size="11" fill="#64748b" text-anchor="middle">5 BATCH, 6 REDEEM(disabled), 7 MINT, 8 SET_CLAIM_REQUIREMENTS</text>
  <text x="579" y="409" font-size="11" fill="#64748b" text-anchor="middle">`encodeAbiParameters` -> report bytes</text>

  <rect x="404" y="444" width="350" height="92" rx="8" fill="#ffffff" stroke="#cbd5e1" stroke-width="1.5"/>
  <text x="579" y="467" font-size="13" font-weight="700" fill="#334155" text-anchor="middle">ACE API Actions</text>
  <text x="579" y="487" font-size="11" fill="#64748b" text-anchor="middle">`ACE_GENERATE_SHIELDED_ADDRESS`</text>
  <text x="579" y="504" font-size="11" fill="#64748b" text-anchor="middle">`ACE_PRIVATE_TRANSFER`, `ACE_WITHDRAW_TICKET`</text>
  <text x="579" y="521" font-size="11" fill="#64748b" text-anchor="middle">Signs EIP-712 using CRE secrets</text>

  <rect x="384" y="575" width="390" height="120" rx="10" fill="#eef2ff" stroke="#a5b4fc" stroke-width="2"/>
  <text x="579" y="605" font-size="17" font-weight="700" fill="#312e81" text-anchor="middle">EVM Write Path</text>
  <text x="579" y="626" font-size="12" fill="#4338ca" text-anchor="middle">Production: `runtime.report()` -> `writeReport(receiver)`</text>
  <text x="579" y="644" font-size="12" fill="#4338ca" text-anchor="middle">Local test mode: direct `receiver.onReport(metadata, report)`</text>
  <text x="579" y="663" font-size="11" fill="#6366f1" text-anchor="middle">same payload encoding, different entrypoint</text>

  <rect x="384" y="715" width="390" height="84" rx="10" fill="#f0fdf4" stroke="#86efac" stroke-width="2"/>
  <text x="579" y="745" font-size="17" font-weight="700" fill="#166534" text-anchor="middle">EVM Log Trigger</text>
  <text x="579" y="766" font-size="12" fill="#166534" text-anchor="middle">Consumes onchain logs and can POST sync events to Lambda</text>

  <rect x="384" y="819" width="390" height="96" rx="10" fill="#faf5ff" stroke="#d8b4fe" stroke-width="2"/>
  <text x="579" y="849" font-size="17" font-weight="700" fill="#6d28d9" text-anchor="middle">HTTP Capability</text>
  <text x="579" y="869" font-size="12" fill="#7c3aed" text-anchor="middle">Sends signed requests to ACE REST API</text>
  <text x="579" y="887" font-size="11" fill="#7c3aed" text-anchor="middle">domain: CompliantPrivateTokenDemo, chainId 11155111</text>

  <!-- Onchain blocks -->
  <rect x="834" y="190" width="320" height="110" rx="10" fill="#4f46e5" stroke="#818cf8" stroke-width="2"/>
  <text x="994" y="222" font-size="18" font-weight="700" fill="#ffffff" text-anchor="middle">EquityWorkflowReceiver.sol</text>
  <text x="994" y="242" font-size="12" fill="#dbeafe" text-anchor="middle">Dispatches action payloads to protocol targets</text>
  <text x="994" y="260" font-size="11" fill="#e0e7ff" text-anchor="middle">SYNC_REDEEM_TICKET intentionally disabled</text>
  <text x="994" y="277" font-size="11" fill="#e0e7ff" text-anchor="middle">(redeem must be called by employee wallet)</text>

  <rect x="834" y="320" width="320" height="80" rx="8" fill="#334155" stroke="#64748b" stroke-width="1.5"/>
  <text x="994" y="350" font-size="16" font-weight="700" fill="#f8fafc" text-anchor="middle">IdentityRegistry</text>
  <text x="994" y="371" font-size="11" fill="#cbd5e1" text-anchor="middle">registerIdentity / setCountry / deleteIdentity</text>

  <rect x="834" y="414" width="320" height="90" rx="8" fill="#0f172a" stroke="#22c55e" stroke-width="1.8"/>
  <text x="994" y="446" font-size="16" font-weight="700" fill="#f8fafc" text-anchor="middle">ERC-3643 Token</text>
  <text x="994" y="467" font-size="11" fill="#bbf7d0" text-anchor="middle">mint() + setAddressFrozen() from receiver actions</text>
  <text x="994" y="484" font-size="11" fill="#bbf7d0" text-anchor="middle">freeze mirrors employee eligibility status</text>

  <rect x="834" y="520" width="320" height="160" rx="8" fill="#082f49" stroke="#38bdf8" stroke-width="1.8"/>
  <text x="994" y="551" font-size="16" font-weight="700" fill="#e0f2fe" text-anchor="middle">PrivateEmployeeEquity</text>
  <text x="994" y="572" font-size="11" fill="#bae6fd" text-anchor="middle">employmentStatus + goalsAchieved</text>
  <text x="994" y="589" font-size="11" fill="#bae6fd" text-anchor="middle">setClaimRequirements(cliffEndTimestamp, goalId, goalRequired)</text>
  <text x="994" y="606" font-size="11" fill="#bae6fd" text-anchor="middle">isEmployeeEligible() gates claim window</text>
  <text x="994" y="623" font-size="11" fill="#bae6fd" text-anchor="middle">depositToVault(amount) -> official ACE vault</text>
  <text x="994" y="640" font-size="11" fill="#bae6fd" text-anchor="middle">uses ACE policy checks via registered policy engine</text>

  <rect x="834" y="700" width="320" height="80" rx="8" fill="#1f2937" stroke="#9ca3af" stroke-width="1.5"/>
  <text x="994" y="730" font-size="15" font-weight="700" fill="#f8fafc" text-anchor="middle">Official ACE Vault (Sepolia)</text>
  <text x="994" y="751" font-size="11" fill="#d1d5db" text-anchor="middle">deposit / withdrawWithTicket / policy enforcement</text>

  <rect x="834" y="796" width="320" height="115" rx="8" fill="#052e16" stroke="#34d399" stroke-width="1.8"/>
  <text x="994" y="828" font-size="16" font-weight="700" fill="#ecfdf5" text-anchor="middle">Employee Onchain Redeem</text>
  <text x="994" y="849" font-size="11" fill="#a7f3d0" text-anchor="middle">Employee wallet calls vault.withdrawWithTicket()</text>
  <text x="994" y="866" font-size="11" fill="#a7f3d0" text-anchor="middle">before deadline (ticket ~1h validity)</text>
  <text x="994" y="883" font-size="11" fill="#a7f3d0" text-anchor="middle">success emits Withdraw event and finalizes flow</text>

  <!-- ACE offchain blocks -->
  <rect x="1214" y="190" width="302" height="130" rx="10" fill="#ffffff" stroke="#d8b4fe" stroke-width="2"/>
  <text x="1365" y="220" font-size="18" font-weight="700" fill="#5b21b6" text-anchor="middle">ACE REST API</text>
  <text x="1365" y="242" font-size="12" fill="#6d28d9" text-anchor="middle">https://convergence2026-token-api.cldev.cloud</text>
  <text x="1365" y="261" font-size="11" fill="#7c3aed" text-anchor="middle">/balances, /private-transfer, /withdraw, /shielded-address</text>
  <text x="1365" y="279" font-size="11" fill="#7c3aed" text-anchor="middle">all requests authenticated with EIP-712 signatures</text>

  <rect x="1214" y="340" width="302" height="110" rx="10" fill="#ffffff" stroke="#d8b4fe" stroke-width="2"/>
  <text x="1365" y="370" font-size="17" font-weight="700" fill="#5b21b6" text-anchor="middle">Private Balance Rail</text>
  <text x="1365" y="391" font-size="11" fill="#6d28d9" text-anchor="middle">Vault Deposit event -> private balance credit</text>
  <text x="1365" y="408" font-size="11" fill="#6d28d9" text-anchor="middle">Private transfer checks `checkPrivateTransferAllowed()`</text>
  <text x="1365" y="425" font-size="11" fill="#6d28d9" text-anchor="middle">shielded addresses supported</text>

  <rect x="1214" y="468" width="302" height="110" rx="10" fill="#ffffff" stroke="#d8b4fe" stroke-width="2"/>
  <text x="1365" y="498" font-size="17" font-weight="700" fill="#5b21b6" text-anchor="middle">Ticket Issuance</text>
  <text x="1365" y="519" font-size="11" fill="#6d28d9" text-anchor="middle">POST /withdraw deducts private balance immediately</text>
  <text x="1365" y="536" font-size="11" fill="#6d28d9" text-anchor="middle">returns signed ticket + deadline</text>
  <text x="1365" y="553" font-size="11" fill="#6d28d9" text-anchor="middle">if not redeemed onchain, balance is refunded</text>

  <rect x="1214" y="596" width="302" height="140" rx="10" fill="#ffffff" stroke="#d8b4fe" stroke-width="2"/>
  <text x="1365" y="626" font-size="17" font-weight="700" fill="#5b21b6" text-anchor="middle">Wallet Roles</text>
  <text x="1365" y="648" font-size="11" fill="#6d28d9" text-anchor="middle">Admin wallet: source for mint/deposit/transfer flows</text>
  <text x="1365" y="665" font-size="11" fill="#6d28d9" text-anchor="middle">Employee wallet: signs /withdraw and redeems onchain</text>
  <text x="1365" y="682" font-size="11" fill="#6d28d9" text-anchor="middle">CRE can also sign ACE actions via configured secrets</text>
  <text x="1365" y="699" font-size="11" fill="#6d28d9" text-anchor="middle">(for automated operations)</text>

  <rect x="1214" y="756" width="302" height="155" rx="10" fill="#faf5ff" stroke="#c084fc" stroke-width="2"/>
  <text x="1365" y="786" font-size="17" font-weight="700" fill="#6d28d9" text-anchor="middle">Resulting Behavior</text>
  <text x="1365" y="807" font-size="11" fill="#7c3aed" text-anchor="middle">Compliance is centralized in ACE policy engine</text>
  <text x="1365" y="824" font-size="11" fill="#7c3aed" text-anchor="middle">Claim eligibility is gated by employment + goal + cliff</text>
  <text x="1365" y="841" font-size="11" fill="#7c3aed" text-anchor="middle">Wallet freeze is automatically synced from eligibility</text>
  <text x="1365" y="858" font-size="11" fill="#7c3aed" text-anchor="middle">Final token release occurs by employee redeem tx</text>
  <text x="1365" y="875" font-size="11" fill="#7c3aed" text-anchor="middle">on Ethereum Sepolia (chainId 11155111)</text>

  <!-- Flow lines -->
  <path d="M 324 365 L 360 365 L 360 230 L 384 230" fill="none" stroke="#2563eb" stroke-width="3" marker-end="url(#arrBlue)"/>
  <path d="M 324 540 L 350 540 L 350 640 L 384 640" fill="none" stroke="#ea580c" stroke-width="3" stroke-dasharray="5 5" marker-end="url(#arrOrange)"/>

  <path d="M 774 640 L 804 640 L 804 245 L 834 245" fill="none" stroke="#2563eb" stroke-width="3" marker-end="url(#arrBlue)"/>
  <path d="M 774 867 L 1100 867 L 1100 255 L 1214 255" fill="none" stroke="#7c3aed" stroke-width="3" marker-end="url(#arrPurple)"/>

  <path d="M 994 300 L 994 320" fill="none" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrBlue)"/>
  <path d="M 994 400 L 994 414" fill="none" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrBlue)"/>
  <path d="M 994 504 L 994 520" fill="none" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrBlue)"/>
  <path d="M 994 680 L 994 700" fill="none" stroke="#94a3b8" stroke-width="2" marker-end="url(#arrBlue)"/>

  <path d="M 1154 740 L 1200 740 L 1200 395 L 1214 395" fill="none" stroke="#7c3aed" stroke-width="2.5" marker-end="url(#arrPurple)"/>
  <path d="M 1516 523 L 1550 523 L 1550 853 L 1154 853" fill="none" stroke="#10b981" stroke-width="3" marker-end="url(#arrGreen)"/>

  <path d="M 834 853 L 804 853 L 804 757 L 774 757" fill="none" stroke="#10b981" stroke-width="3" marker-end="url(#arrGreen)"/>
  <path d="M 384 757 L 360 757 L 360 365 L 324 365" fill="none" stroke="#10b981" stroke-width="3" marker-end="url(#arrGreen)"/>

  <!-- Legend -->
  <rect x="24" y="948" width="1512" height="24" rx="8" fill="#ffffff" stroke="#cbd5e1" stroke-width="1.5"/>
  <line x1="44" y1="960" x2="84" y2="960" stroke="#2563eb" stroke-width="3" marker-end="url(#arrBlue)"/>
  <text x="92" y="964" font-size="11" fill="#334155">Onchain execution path</text>
  <line x1="265" y1="960" x2="305" y2="960" stroke="#10b981" stroke-width="3" marker-end="url(#arrGreen)"/>
  <text x="313" y="964" font-size="11" fill="#334155">Event / completion sync</text>
  <line x1="488" y1="960" x2="528" y2="960" stroke="#7c3aed" stroke-width="3" marker-end="url(#arrPurple)"/>
  <text x="536" y="964" font-size="11" fill="#334155">ACE private API/ticket rail</text>
  <line x1="742" y1="960" x2="782" y2="960" stroke="#ea580c" stroke-width="3" stroke-dasharray="5 5" marker-end="url(#arrOrange)"/>
  <text x="790" y="964" font-size="11" fill="#334155">Local direct receiver test path</text>
</svg>
