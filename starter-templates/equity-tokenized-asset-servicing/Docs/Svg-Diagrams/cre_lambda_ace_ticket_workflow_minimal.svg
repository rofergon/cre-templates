<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1280 780" width="100%" height="100%" style="background:#f8fafc; font-family:'Segoe UI','Inter',sans-serif;">
  <defs>
    <linearGradient id="hdr" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#2a5ada"/>
      <stop offset="100%" stop-color="#193db0"/>
    </linearGradient>
    <filter id="soft" x="-10%" y="-10%" width="120%" height="120%">
      <feDropShadow dx="0" dy="3" stdDeviation="6" flood-color="#000000" flood-opacity="0.10"/>
    </filter>
    <marker id="arr" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="7" markerHeight="7" orient="auto">
      <path d="M0 0 L10 5 L0 10 z" fill="#334155"/>
    </marker>
    <marker id="arrBlue" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="7" markerHeight="7" orient="auto">
      <path d="M0 0 L10 5 L0 10 z" fill="#2563eb"/>
    </marker>
    <marker id="arrGreen" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="7" markerHeight="7" orient="auto">
      <path d="M0 0 L10 5 L0 10 z" fill="#15803d"/>
    </marker>
  </defs>

  <text x="640" y="44" text-anchor="middle" font-size="30" font-weight="700" fill="#1e293b">Minimal E2E Flow: Lambda + CRE + ACE Ticket</text>
  <text x="640" y="72" text-anchor="middle" font-size="14" fill="#64748b">npm --prefix EquityWorkflowCre run test:lambda-cre-ace-ticket</text>

  <rect x="36" y="96" width="1208" height="648" rx="16" fill="#ffffff" stroke="#2a5ada" stroke-width="3" filter="url(#soft)"/>
  <rect x="36" y="96" width="1208" height="58" rx="16" fill="url(#hdr)"/>
  <path d="M36 136 L1244 136 L1244 154 L36 154 Z" fill="url(#hdr)"/>
  <text x="640" y="133" text-anchor="middle" font-size="21" font-weight="700" fill="#ffffff">What happens in the passing test run</text>

  <rect x="84" y="198" width="268" height="96" rx="10" fill="#f0fdf4" stroke="#86efac" stroke-width="2"/>
  <text x="218" y="226" text-anchor="middle" font-size="16" font-weight="700" fill="#166534">1) Lambda state seed</text>
  <text x="218" y="246" text-anchor="middle" font-size="12" fill="#166534">Saves employee KYC + HR snapshot.</text>
  <text x="218" y="264" text-anchor="middle" font-size="11" fill="#22c55e">This is the source-of-truth input for the flow.</text>

  <rect x="398" y="198" width="268" height="96" rx="10" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="2"/>
  <text x="532" y="226" text-anchor="middle" font-size="16" font-weight="700" fill="#334155">2) CRE onchain sync</text>
  <text x="532" y="246" text-anchor="middle" font-size="12" fill="#475569">`SYNC_KYC` + `SYNC_FREEZE_WALLET`</text>
  <text x="532" y="264" text-anchor="middle" font-size="11" fill="#64748b">Receiver updates IdentityRegistry and token freeze flag.</text>

  <rect x="712" y="198" width="268" height="96" rx="10" fill="#eff6ff" stroke="#93c5fd" stroke-width="2"/>
  <text x="846" y="226" text-anchor="middle" font-size="16" font-weight="700" fill="#1d4ed8">3) Preconditions check</text>
  <text x="846" y="246" text-anchor="middle" font-size="12" fill="#1e3a8a">Employee is verified and has gas.</text>
  <text x="846" y="264" text-anchor="middle" font-size="11" fill="#2563eb">Test aborts here if compliance is not satisfied.</text>

  <rect x="84" y="346" width="420" height="124" rx="10" fill="#eff6ff" stroke="#93c5fd" stroke-width="2"/>
  <text x="294" y="374" text-anchor="middle" font-size="16" font-weight="700" fill="#1d4ed8">4) Funding branch (if private balance is low)</text>
  <text x="294" y="394" text-anchor="middle" font-size="12" fill="#1e3a8a">Optional `SYNC_MINT` to admin, then KYC checks for admin + vault.</text>
  <text x="294" y="412" text-anchor="middle" font-size="12" fill="#1e3a8a">`approve + deposit` into official ACE vault.</text>
  <text x="294" y="432" text-anchor="middle" font-size="11" fill="#2563eb">Why: ERC-3643 requires receiver verification ("Receiver not verified" fix).</text>
  <rect x="184" y="440" width="220" height="20" rx="8" fill="#ffffff" stroke="#bfdbfe" stroke-width="1"/>
  <text x="294" y="454" text-anchor="middle" font-size="10" fill="#1d4ed8">Gate: checkDepositAllowed()</text>

  <rect x="544" y="346" width="420" height="124" rx="10" fill="#ede9fe" stroke="#c4b5fd" stroke-width="2"/>
  <text x="754" y="374" text-anchor="middle" font-size="16" font-weight="700" fill="#5b21b6">5) Private movement in ACE API</text>
  <text x="754" y="394" text-anchor="middle" font-size="12" fill="#6d28d9">`/private-transfer`: admin -&gt; employee (offchain private ledger).</text>
  <text x="754" y="412" text-anchor="middle" font-size="12" fill="#6d28d9">`/withdraw`: employee requests signed ticket.</text>
  <text x="754" y="432" text-anchor="middle" font-size="11" fill="#7c3aed">Policy engine validation applies before operations are accepted.</text>
  <rect x="656" y="440" width="196" height="20" rx="8" fill="#ffffff" stroke="#ddd6fe" stroke-width="1"/>
  <text x="754" y="454" text-anchor="middle" font-size="10" fill="#6d28d9">Ticket has deadline (1h)</text>

  <rect x="362" y="532" width="556" height="122" rx="12" fill="#ecfeff" stroke="#67e8f9" stroke-width="2"/>
  <text x="640" y="564" text-anchor="middle" font-size="19" font-weight="700" fill="#0e7490">6) Final redeem on Sepolia</text>
  <text x="640" y="588" text-anchor="middle" font-size="13" fill="#155e75">Employee wallet executes `withdrawWithTicket(token, amount, ticket)`.</text>
  <text x="640" y="608" text-anchor="middle" font-size="13" fill="#155e75">Private balance is materialized as onchain token balance.</text>
  <text x="640" y="628" text-anchor="middle" font-size="11" fill="#0e7490">Test asserts balance delta and exits SUCCESS.</text>

  <rect x="324" y="682" width="632" height="42" rx="10" fill="#fefce8" stroke="#facc15" stroke-width="2"/>
  <text x="640" y="709" text-anchor="middle" font-size="18" font-weight="700" fill="#854d0e">Outcome: compliant employee can claim with ACE ticket end-to-end</text>

  <path d="M352 246 L398 246" fill="none" stroke="#334155" stroke-width="2.5" marker-end="url(#arr)"/>
  <path d="M666 246 L712 246" fill="none" stroke="#334155" stroke-width="2.5" marker-end="url(#arr)"/>
  <path d="M846 294 L846 332 L754 332 L754 346" fill="none" stroke="#2563eb" stroke-width="3" marker-end="url(#arrBlue)"/>
  <path d="M712 246 L294 246 L294 346" fill="none" stroke="#2563eb" stroke-width="3" marker-end="url(#arrBlue)"/>
  <path d="M504 408 L544 408" fill="none" stroke="#2563eb" stroke-width="3" marker-end="url(#arrBlue)"/>
  <path d="M754 470 L754 520 L640 520 L640 532" fill="none" stroke="#15803d" stroke-width="3" marker-end="url(#arrGreen)"/>
  <path d="M294 470 L294 520 L500 520 L500 532" fill="none" stroke="#15803d" stroke-width="3" marker-end="url(#arrGreen)"/>
  <path d="M640 654 L640 682" fill="none" stroke="#15803d" stroke-width="3" marker-end="url(#arrGreen)"/>

  <rect x="62" y="706" width="236" height="28" rx="14" fill="#dbeafe" stroke="#93c5fd" stroke-width="1.5"/>
  <text x="180" y="725" text-anchor="middle" font-size="11" fill="#1d4ed8">Network: Ethereum Sepolia (11155111)</text>

  <rect x="1014" y="706" width="214" height="28" rx="14" fill="#dcfce7" stroke="#86efac" stroke-width="1.5"/>
  <text x="1121" y="725" text-anchor="middle" font-size="11" fill="#15803d">API: convergence2026-token-api.cldev.cloud</text>
</svg>
