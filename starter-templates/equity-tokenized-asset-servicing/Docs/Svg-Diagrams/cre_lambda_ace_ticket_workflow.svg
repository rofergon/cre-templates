<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 920" width="100%" height="100%" style="background-color: #f8fafc; font-family: 'Segoe UI', 'Inter', -apple-system, sans-serif;">
  <defs>
    <filter id="shadow-sm" x="-10%" y="-10%" width="120%" height="120%">
      <feDropShadow dx="0" dy="2" stdDeviation="4" flood-color="#000000" flood-opacity="0.06"/>
    </filter>
    <filter id="shadow-md" x="-10%" y="-10%" width="120%" height="120%">
      <feDropShadow dx="0" dy="6" stdDeviation="8" flood-color="#000000" flood-opacity="0.10"/>
    </filter>

    <linearGradient id="cre-grad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" stop-color="#2a5ada"/>
      <stop offset="100%" stop-color="#193db0"/>
    </linearGradient>

    <marker id="arrowSolid" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#334155"/>
    </marker>
    <marker id="arrowBlue" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#2a5ada"/>
    </marker>
    <marker id="arrowGreen" viewBox="0 0 10 10" refX="8" refY="5" markerWidth="6" markerHeight="6" orient="auto">
      <path d="M 0 0 L 10 5 L 0 10 z" fill="#15803d"/>
    </marker>
  </defs>

  <text x="700" y="46" font-size="30" font-weight="bold" fill="#1e293b" text-anchor="middle">E2E Test Flow: Lambda - CRE - ACE Ticket - Redeem</text>
  <text x="700" y="76" font-size="15" fill="#64748b" text-anchor="middle">Command: npm --prefix EquityWorkflowCre run test:lambda-cre-ace-ticket</text>

  <rect x="40" y="100" width="1320" height="790" rx="18" fill="#ffffff" stroke="#2a5ada" stroke-width="3" filter="url(#shadow-md)"/>
  <rect x="40" y="100" width="1320" height="64" rx="18" fill="url(#cre-grad)"/>
  <path d="M 40 146 L 1360 146 L 1360 164 L 40 164 Z" fill="url(#cre-grad)"/>
  <text x="700" y="140" font-size="22" font-weight="bold" fill="#ffffff" text-anchor="middle">Operational Path Used In The Passing E2E Run</text>

  <text x="190" y="212" font-size="15" font-weight="bold" fill="#64748b" text-anchor="middle">TRIGGERS &amp; STATE</text>
  <text x="530" y="212" font-size="15" font-weight="bold" fill="#64748b" text-anchor="middle">ONCHAIN SYNC (RECEIVER)</text>
  <text x="875" y="212" font-size="15" font-weight="bold" fill="#64748b" text-anchor="middle">VAULT FUNDING PATH</text>
  <text x="1200" y="212" font-size="15" font-weight="bold" fill="#64748b" text-anchor="middle">ACE PRIVATE API</text>

  <rect x="500" y="186" width="400" height="54" rx="8" fill="#eff6ff" stroke="#93c5fd" stroke-width="2"/>
  <text x="700" y="208" font-size="14" font-weight="bold" fill="#1e3a8a" text-anchor="middle">Report path: direct onReport (receiver test mode)</text>
  <text x="700" y="226" font-size="12" fill="#2563eb" text-anchor="middle">No forwarder dependency during local E2E simulation</text>

  <rect x="90" y="260" width="250" height="90" rx="10" fill="#f0fdf4" stroke="#86efac" stroke-width="2"/>
  <text x="215" y="288" font-size="15" font-weight="bold" fill="#166534" text-anchor="middle">0) Test Entry</text>
  <text x="215" y="308" font-size="12" fill="#166534" text-anchor="middle">npm script starts wallet + config</text>
  <text x="215" y="325" font-size="11" fill="#22c55e" text-anchor="middle">Admin / Employee / Token / Vault context</text>

  <rect x="90" y="390" width="250" height="92" rx="10" fill="#f0fdf4" stroke="#86efac" stroke-width="2"/>
  <text x="215" y="418" font-size="15" font-weight="bold" fill="#166534" text-anchor="middle">1) Lambda Persist</text>
  <text x="215" y="438" font-size="12" fill="#166534" text-anchor="middle">CompanyEmployeeInput</text>
  <text x="215" y="455" font-size="11" fill="#22c55e" text-anchor="middle">employee, identity, country, KYC, freeze</text>

  <rect x="390" y="250" width="280" height="88" rx="10" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="2"/>
  <text x="530" y="278" font-size="15" font-weight="bold" fill="#334155" text-anchor="middle">2) SYNC_KYC</text>
  <text x="530" y="298" font-size="12" fill="#475569" text-anchor="middle">Receiver writes IdentityRegistry</text>
  <text x="530" y="316" font-size="11" fill="#64748b" text-anchor="middle">employee = verified, identity, country</text>

  <rect x="390" y="360" width="280" height="88" rx="10" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="2"/>
  <text x="530" y="388" font-size="15" font-weight="bold" fill="#334155" text-anchor="middle">2b) SYNC_FREEZE_WALLET</text>
  <text x="530" y="408" font-size="12" fill="#475569" text-anchor="middle">Receiver calls token.setAddressFrozen</text>
  <text x="530" y="426" font-size="11" fill="#64748b" text-anchor="middle">target employee = false</text>

  <rect x="390" y="470" width="280" height="88" rx="10" fill="#f1f5f9" stroke="#cbd5e1" stroke-width="2"/>
  <text x="530" y="498" font-size="15" font-weight="bold" fill="#334155" text-anchor="middle">3) Verify Employee Onchain</text>
  <text x="530" y="518" font-size="12" fill="#475569" text-anchor="middle">isVerified + identity + country + !frozen</text>
  <text x="530" y="536" font-size="11" fill="#64748b" text-anchor="middle">Then ensure employee has ETH gas for redeem</text>

  <rect x="730" y="250" width="290" height="88" rx="10" fill="#eff6ff" stroke="#93c5fd" stroke-width="2"/>
  <text x="875" y="278" font-size="15" font-weight="bold" fill="#1d4ed8" text-anchor="middle">4) Check Admin Private Balance</text>
  <text x="875" y="298" font-size="12" fill="#1e3a8a" text-anchor="middle">ACE /balances (EIP-712 signed)</text>
  <text x="875" y="316" font-size="11" fill="#2563eb" text-anchor="middle">If insufficient, open funding branch</text>

  <rect x="730" y="358" width="290" height="136" rx="10" fill="#eff6ff" stroke="#93c5fd" stroke-width="2"/>
  <text x="875" y="384" font-size="15" font-weight="bold" fill="#1d4ed8" text-anchor="middle">5) Funding Branch (Conditional)</text>
  <text x="875" y="404" font-size="12" fill="#1e3a8a" text-anchor="middle">SYNC_MINT for admin if token balance low</text>
  <text x="875" y="422" font-size="12" fill="#1e3a8a" text-anchor="middle">Ensure admin identity verified</text>
  <text x="875" y="440" font-size="12" fill="#1e3a8a" text-anchor="middle">Ensure vault identity verified</text>
  <text x="875" y="462" font-size="11" fill="#2563eb" text-anchor="middle">Prevents ERC-3643 revert: "Receiver not verified"</text>
  <rect x="785" y="470" width="180" height="18" rx="6" fill="#ffffff" stroke="#bfdbfe" stroke-width="1"/>
  <text x="875" y="483" font-size="10" fill="#1d4ed8" text-anchor="middle">checkDepositAllowed() gate</text>

  <rect x="730" y="515" width="290" height="102" rx="10" fill="#eff6ff" stroke="#93c5fd" stroke-width="2"/>
  <text x="875" y="543" font-size="15" font-weight="bold" fill="#1d4ed8" text-anchor="middle">5b) Deposit Into ACE Vault</text>
  <text x="875" y="563" font-size="12" fill="#1e3a8a" text-anchor="middle">token.approve(vault, amount)</text>
  <text x="875" y="581" font-size="12" fill="#1e3a8a" text-anchor="middle">vault.deposit(token, missingAmount)</text>
  <text x="875" y="599" font-size="11" fill="#2563eb" text-anchor="middle">Wait until admin private balance is credited</text>

  <rect x="1080" y="288" width="240" height="102" rx="10" fill="#ede9fe" stroke="#c4b5fd" stroke-width="2"/>
  <text x="1200" y="316" font-size="15" font-weight="bold" fill="#5b21b6" text-anchor="middle">6) /private-transfer</text>
  <text x="1200" y="336" font-size="12" fill="#6d28d9" text-anchor="middle">Admin -&gt; Employee (offchain private rail)</text>
  <text x="1200" y="354" font-size="11" fill="#7c3aed" text-anchor="middle">Validated with policy engine checks</text>
  <text x="1200" y="372" font-size="11" fill="#7c3aed" text-anchor="middle">Employee private balance increases</text>

  <rect x="1080" y="470" width="240" height="102" rx="10" fill="#ede9fe" stroke="#c4b5fd" stroke-width="2"/>
  <text x="1200" y="498" font-size="15" font-weight="bold" fill="#5b21b6" text-anchor="middle">7) /withdraw + Ticket</text>
  <text x="1200" y="518" font-size="12" fill="#6d28d9" text-anchor="middle">Employee signs EIP-712 withdraw request</text>
  <text x="1200" y="536" font-size="11" fill="#7c3aed" text-anchor="middle">Receives ticket + 1h deadline</text>
  <text x="1200" y="554" font-size="11" fill="#7c3aed" text-anchor="middle">checkWithdrawAllowed() already passed</text>

  <rect x="540" y="656" width="320" height="112" rx="12" fill="#ecfeff" stroke="#67e8f9" stroke-width="2"/>
  <text x="700" y="688" font-size="17" font-weight="bold" fill="#0e7490" text-anchor="middle">8) Onchain Redeem</text>
  <text x="700" y="711" font-size="13" fill="#155e75" text-anchor="middle">Employee wallet calls:</text>
  <text x="700" y="732" font-size="13" font-weight="bold" fill="#0f766e" text-anchor="middle">vault.withdrawWithTicket(token, amount, ticket)</text>
  <text x="700" y="752" font-size="11" fill="#0e7490" text-anchor="middle">Token balance on employee wallet increases</text>

  <rect x="300" y="798" width="800" height="64" rx="12" fill="#fefce8" stroke="#facc15" stroke-width="2"/>
  <text x="700" y="826" font-size="20" font-weight="bold" fill="#854d0e" text-anchor="middle">SUCCESS: Employee compliant + ACE ticket redeemed</text>
  <text x="700" y="846" font-size="12" fill="#a16207" text-anchor="middle">Validated in the latest E2E run over Sepolia + official ACE demo API</text>

  <path d="M 340 305 L 390 294" fill="none" stroke="#334155" stroke-width="2" marker-end="url(#arrowSolid)"/>
  <path d="M 215 350 L 215 390" fill="none" stroke="#334155" stroke-width="2" marker-end="url(#arrowSolid)"/>
  <path d="M 340 436 L 390 404" fill="none" stroke="#334155" stroke-width="2" marker-end="url(#arrowSolid)"/>
  <path d="M 530 338 L 530 360" fill="none" stroke="#334155" stroke-width="2" marker-end="url(#arrowSolid)"/>
  <path d="M 530 448 L 530 470" fill="none" stroke="#334155" stroke-width="2" marker-end="url(#arrowSolid)"/>

  <path d="M 670 516 L 730 294" fill="none" stroke="#2a5ada" stroke-width="3" marker-end="url(#arrowBlue)"/>
  <path d="M 875 338 L 875 358" fill="none" stroke="#2a5ada" stroke-width="3" marker-end="url(#arrowBlue)"/>
  <path d="M 875 494 L 875 515" fill="none" stroke="#2a5ada" stroke-width="3" marker-end="url(#arrowBlue)"/>
  <path d="M 1020 566 L 1080 521" fill="none" stroke="#2a5ada" stroke-width="3" marker-end="url(#arrowBlue)"/>

  <path d="M 1020 300 L 1080 338" fill="none" stroke="#15803d" stroke-width="3" marker-end="url(#arrowGreen)"/>
  <path d="M 1200 390 L 1200 470" fill="none" stroke="#15803d" stroke-width="3" marker-end="url(#arrowGreen)"/>
  <path d="M 1080 572 L 860 700" fill="none" stroke="#15803d" stroke-width="3" marker-end="url(#arrowGreen)"/>
  <path d="M 700 768 L 700 798" fill="none" stroke="#15803d" stroke-width="3" marker-end="url(#arrowGreen)"/>

  <rect x="80" y="846" width="230" height="28" rx="14" fill="#dbeafe" stroke="#93c5fd" stroke-width="1.5"/>
  <text x="195" y="865" font-size="11" fill="#1d4ed8" text-anchor="middle">Network: Sepolia (11155111)</text>

  <rect x="1110" y="846" width="250" height="28" rx="14" fill="#dcfce7" stroke="#86efac" stroke-width="1.5"/>
  <text x="1235" y="865" font-size="11" fill="#15803d" text-anchor="middle">ACE API: convergence2026-token-api.cldev.cloud</text>
</svg>
